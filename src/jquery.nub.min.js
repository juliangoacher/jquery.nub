(function($){$.nub={identity:function(a){return a},noop:function(){},constant:function(c){return function(){return c}},criteria:{equals:function(id,value,nonEmptyValue){if(value===undefined){return $.nub.constant(true)}if(!value&&nonEmptyValue){return $.nub.constant(true)}return function(obj){return obj!==undefined&&obj[id]==value}},lte:function(id,value){if(value===undefined){return $.nub.constant(true)}return function(obj){return obj!==undefined&&obj[id]<=value}},gte:function(id,value){if(value===undefined){return $.nub.constant(true)}return function(obj){return obj!==undefined&&obj[id]>=value}}},model:{data:{},views:{},types:{}}};function PathTraversalFrame(path,obj){var idx=0;this.obj=obj;this.steps=[];this.path=[];this.nextID=function(){return path[idx]};this.next=function(){this.id=path[idx++];this.path.push(this.id);this.steps.push(this.obj);this.obj=this.obj[this.id]};this.set=function(val){this.steps[idx-1][this.id]=this.obj=val};this.del=function(){delete this.steps[idx-1][this.id];delete this.obj};this.end=function(){return this.steps.length>=path.length};this.remaining=function(){return path.slice(idx)};this.pathToFrame=function(){return makePath(this.path.slice(0))}}function BaseMVCType(bindings,initCons){this.bindings=bindings||{};this.bindings["*"]=$.nub.model.types["$default"]||this;initCons=initCons||Object;this.ops={get:function(frame,opts,value){return frame.obj},set:function(frame,opts,value){frame.set(value);$.nub.notify("set",frame);return value},del:function(frame,opts,value){value=frame.obj;frame.del();$.nub.notify("delete",frame);return value}};this.step=function(op,frame,opts,value){if(frame.end()){return this.ops[op](frame,opts,value,this)}var type=this.getType(frame.nextID());frame.next();if(frame.obj===undefined){if((op=="get"&&frame.end()?type.initOnGet:type.initOnRef)||(op=="set"&&type.initOnRef)){frame.set(type.init(frame,opts,value))}else{return undefined}}return type[op](frame,opts,value)};this.initOnGet=false;this.initOnRef=true;this.init=function(frame,opts,value){return new initCons()};this.get=function(frame,opts){return this.step("get",frame,opts)};this.set=function(frame,opts,value){return this.step("set",frame,opts,value)};this.del=function(frame,opts,value){return this.step("del",frame,opts,value)};this.apply=function(op,ref,rcx,opts,opargs){var frame=new PathTraversalFrame($.nub.path(ref,rcx).copy(),$.nub.model);var args=[frame,opts||$.nub.model.options].concat(opargs);return this[op].apply(this,args)};this.getType=function(id){return this.bindings[id]||this.bindings["*"]};this.bind=function(ref,type){if(ref.isModelPath){var id=ref.shift();if(ref.length==0){this.bindings[id]=type}else{var subtype=this.bindings[id];if(!subtype){subtype=this.bindings[id]=new BaseMVCType()}if($.isFunction(subtype.bind)){subtype.bind(ref,type)}}}else{this.bindings[ref]=type}};this.addBindings=function(bindings){for(var ref in bindings){this.bind(ref,bindings[ref])}}}$.nub.BaseMVCType=BaseMVCType;$.nub.model.types["$default"]=new BaseMVCType();$.nub.model.types.base=new BaseMVCType();ArrayMVCType.prototype=new BaseMVCType({},Array);function ArrayMVCType(bindings){this.addBindings(bindings);this.initOnGet=true}ViewMVCType.prototype=new BaseMVCType();function ViewMVCType(){this.bind("*",this);function gatherViews(node,list,deep){if(node){for(var i=0,views=node.__views__;i<views.length;i++){if(!views[i].active){list.push(views[i])}}if(deep){for(var id in node){if(id!="__views__"){list=gatherViews(node[id],list,true)}}}}return list}this.ops.get=function(frame,opts,value){var views=[];for(var i=2;i<frame.steps.length;views=gatherViews(frame.steps[i++],views)){}views=gatherViews(frame.obj,views,true);return views};this.ops.set=function(frame,opts,value){var views=frame.obj.__views__;views.push(value);$.nub.notify("set",frame);return views};this.ops.del=function(frame,opts,value){if(frame.obj!==undefined){var views=frame.obj.__views__;for(var i=0;i<views.length;i+=4){if(views[i][0]===value){views.splice(i,1);$.nub.notify("delete",frame);break}}}};this.init=function(){return{__views__:[]}};this.id="ViewMVCType"}$.nub.model.types.base.bind("views",new ViewMVCType());function DataMVCType(options){$.extend(this,{make:$.nub.identity,format:$.nub.identity,parse:$.nub.identity},options);this.init=function(frame,opts,value){return this.make(value,opts,frame.remaining())};this.get=function(frame,opts){var val=frame.obj;return opts.bare?val:this.format(val,opts,frame.remaining())};this.set=function(frame,opts,newVal){var oldVal=frame.obj;var newVal=opts.bare?newVal:this.parse(newVal,oldVal,opts,frame.remaining());frame.set(newVal);$.nub.notify("set",frame)};this.del=function(frame,opts){frame.del();$.nub.notify("delete",frame)};this.initOnRef=true}$.nub.DataMVCType=DataMVCType;function Remote(ref,opts,methods,uri){var nub=$.nub;ref=nub.path(ref);this.meta={status:"preload"};this.data=undefined;$.extend(this,{serialize:function(){return JSON.stringify(this.data)},onrequest:$.nub.identity,onload:$.nub.identity},methods);this.isLoaded=function(){var status=this.meta.status;return status!==undefined&&!status.match(/^(preload|loading|submitting)/)};this.lazyLoad=function(uri,type,options){if(!this.isLoaded()){this.load(uri,type,options)}};this.whenAvailable=function(callback,repeat){var view=function(){var lp=nub.get(ref);if(lp.isLoaded()){try{callback(lp)}finally{if(!repeat){nub.removeView("meta/status",view,ref)}}}};nub.view("meta/status",view,ref)};function update(remote,ref,uri,status,method,data,error){remote=remote.onload($.extend({},remote,{meta:{error:error,uri:uri,timestamp:new Date(),"ajax-status":status,status:"loaded",initData:JSON.stringify(data)},data:data}),method);nub.set(ref,remote)}this.load=function(uri,type,options){var remote=this;var args=$.extend({url:uri,type:"GET",dataType:type,success:function(data,status){update(remote,ref,uri,status,"GET",data)},error:function(xhr,status,err){update(remote,ref,uri,status,"GET",undefined,err)}},options);args=remote.onrequest(args);nub.set("meta/status",args.type=="GET"?"loading":"submitting",ref);nub.set("meta/dataType",type,ref);return $.ajax(args)};this.get=function(uri,options){return this.load(uri,"json",$.extend(options,{type:"GET"}))};this.put=function(uri,options){uri=uri||this.meta.uri;return this.load(uri,"application/json",$.extend(options,{type:"PUT",data:this.serialize()}))};this.post=function(uri,options){uri=uri||this.meta.uri;return this.load(uri,"application/json",$.extend(options,{type:"POST",data:this.serialize()}))};this.reload=function(){if(this.meta.status=="loaded"){this.load(this.meta.uri,this.meta.dataType)}};this.reset=function(){nub.set("data",JSON.parse(this.meta.initData),ref)};if(uri){var remote=this;var args={url:uri,type:"GET",dataType:"json",success:function(data,status){update(remote,ref,uri,status,"GET",data,undefined)},error:function(xhr,status,err){update(remote,ref,uri,status,"GET",undefined,err)}};this.meta.status="loading";this.meta.dataType="json";$.ajax(args)}}RemoteMVCType.prototype=new BaseMVCType();function RemoteMVCType(methods,uri){this.init=function(frame,opts,value){return new Remote(frame.pathToFrame(),opts,methods,uri)};this.id="RemoteMVCType";this.initOnGet=true}$.nub.RemoteMVCType=RemoteMVCType;$.nub.model.types.remote=new RemoteMVCType();$.nub.model.options={globalContext:"/data",refAttr:"data",isInput:function(elem){return !!elem.type&&elem.type!="button"},getRef:function(elem){return $(elem).attr($.nub.model.options.refAttr)},getInputRef:function(elem){return elem.name},readFormatOptions:function(elem,fopts){return $.extend({},$.nub.model.options.formatOptions,fopts)},formatOptions:{},changeHandler:function(event){$.nub.set(this.name,$(this).val(),event.data[0],event.data[1])},inputView:function(input,path,opt,op){$(input).val($.nub.get(path,undefined,opt))},elemView:function(elem,path,opt,op){$(elem).html($.nub.get(path,undefined,opt))},attrView:function(attr,path,opt,op){attr.value=$.nub.get(path,undefined,opt)},textView:function(text,path,opt,op){$(text).text($.nub.get(path,undefined,opt))}};function selectListView(elem,ref,context){var offset=elem.options.length;return function(){var list=$.nub.get(ref,context);var i,j,len=list!==undefined?list.length||0:0;for(i=0,j=offset;i<len;i++,j++){if(list[i] instanceof Array){elem.options[j]=new Option(list[i][1],list[i][0])}else{elem.options[j]=new Option(list[i])}}for(j=j;j<elem.options.length;j++){elem.options[j]=undefined}}}function getNodeRef(node){return node.getAttribute($.nub.model.options.refAttr)}function makePath(ref){ref.toString=function(i){return"/"+(isNaN(i)?this:this.slice(0,i+1)).join("/")};ref.copy=function(){return makePath(this.slice(0))};ref.inContext=function(context){return makePath(context.split("/").concat(this))};ref.isModelPath=true;return ref}function applyType(type,op,ref,rcontext,opts,opargs){if(typeof(type)=="string"){type=$.nub.model.types[type];if(type===undefined){throw new Error("Unregistered type: "+type)}}opts=opts||$.nub.model.options.formatOptions;return type.apply(op,ref,rcontext,opts,opargs)}$.nub.path=function(ref,context){var path;if(ref===undefined||ref.isModelPath){path=ref}else{if(ref.nodeType){var refs=[];var accumRefs=function(){var nodeRef=getNodeRef(this);if(nodeRef!==null){refs.unshift(nodeRef);if(nodeRef.charAt(0)=="/"){throw true}}};try{accumRefs.apply(ref);$(ref).parents().each(accumRefs)}catch(e){}path=makePath(ref)}else{if(typeof(ref)=="string"){var refs=ref.split("/");while(refs[refs.length-1]==""){refs.length--}if(refs[0]==""){refs.shift();path=makePath(refs)}else{path=makePath($.nub.path(context||$.nub.model.options.globalContext).concat(refs))}}else{if($.isArray(ref)){path=makePath(ref)}}}}return path};$.nub.get=function(ref,context,opts){return applyType($.nub.model.types.base,"get",ref,context,opts)};$.nub.set=function(ref,value,context,opts){return applyType($.nub.model.types.base,"set",ref,context,opts,[value])};$.nub.del=function(ref,value,context,opts){return applyType($.nub.model.types.base,"del",ref,context,opts,[value])};$.nub.notify=function(op,frame){var viewsPath=frame.pathToFrame().inContext("views");var views=$.nub.get(viewsPath);if(views){$.each(views,function(i,v){try{v.active=true;v[0](v[1],v[2],v[3],op);v.active=false}catch(e){if(console!==undefined){console.error("Notifying view: %o",e)}}})}};$.nub.view=function(ref,obj,context,opt,noinit){var fn;if($.isFunction(obj)){fn=obj}else{if(obj.type){fn=$.nub.model.options.inputView;if(obj.type=="select-one"||obj.type=="select-many"){var data=$(obj).attr("data");if(data){$.nub.view(data,selectListView(obj,data,context),context,opt,noinit)}}}else{switch(obj.nodeType){case 1:fn=$.nub.model.options.elemView;break;case 2:fn=$.nub.model.options.attrView;break;case 3:fn=$.nub.model.options.textView;break;default:throw new Error("View must be a HTML element, attribute or text node, or a function")}}}var key=$.nub.path(ref,context);var view=[fn,obj,key,opt];var viewPath=key.inContext("views");$.nub.set(viewPath,view,undefined);if(!noinit){fn(obj,key,context,opt,"set",undefined)}return fn};$.nub.addViewNoInit=function(ref,obj,context,opt){return $.nub.view(ref,obj,context,opt,true)};$.nub.removeView=function(ref,obj,context){var viewPath=$.nub.path(ref,context).inContext("views");$.nub.del(viewPath,obj,undefined)};$.nub.addInput=function(node,context,opts){return $(node).bind("change",[context,opts],$.nub.model.options.changeHandler)};$.nub.type=function(ref,type,context){$.nub.model.types.base.bind($.nub.path(ref,context),type)};$.nub.remote=function(pathOrOptions,uri,methods,bindings){var options;switch(typeof(pathOrOptions)){case"string":options={path:pathOrOptions,uri:uri,methods:methods,bindings:bindings};break;case"object":options=pathOrOptions;break;default:throw new Error("Invalid call to remote(): First arg must be a string or object")}var type=new RemoteMVCType(options.methods,options.uri);$.nub.type(options.path,type,"/remote");var cx="/remote/"+options.path+"/data";for(var id in options.bindings){$.nub.type(id,options.bindings[id],cx)}return type};$.nub.filter=function(filterRef,dataRef,filterFn){var filter={args:[],result:undefined};$.nub.set(filterRef,filter);function filterView(){var sourceData=$.nub.get(dataRef);var result=filterFn.apply(sourceData,$.nub.get("args",filterRef));$.nub.set("result",result,filterRef)}$.nub.addViewNoInit(dataRef,filterView);$.nub.addViewNoInit("args",filterView,filterRef)};$.fn.nub=function(){switch(typeof arguments[0]){case"string":switch(arguments[0]){case"disable":$(this).each(function(){var $e=$(this);if($e.data("nub.ref")!==undefined){$.nub.removeView($e.data("nub.ref"),$e.data("nub.view"),$e.data("nub.context"))}});return this;case"enable":$(this).each(function(){var $e=$(this);if($e.data("nub.ref")!==undefined){$.nub.view($e.data("nub.ref"),$e.data("nub.view"),$e.data("nub.context"))}});return this;case"destroy":$(this).each(function(){var $e=$(this);if($e.data("nub.ref")!==undefined){$.nub.removeView($e.data("nub.ref"),$e.data("nub.view"),$e.data("nub.context"))}$e.removeData("nub.ref");$e.removeData("nub.view");$e.removeData("nub.context")});return this;default:var options=$.extend({context:arguments[0]},$.nub.model.options)}break;case"object":case"undefined":var options=$.extend({},$.nub.model.options,arguments[0]);break;default:throw new Error("Bad argument passed to nub(): "+arguments[0])}$(this).each(function(){if(options.isInput(this)){var fopts=options.readFormatOptions(this,options.formatOptions);var ref=options.getInputRef(this);var view=$.nub.view(ref,this,options.context,fopts);$.nub.addInput(this,options.context,fopts)}else{var ref=options.getRef(this);if(ref!==undefined){var fopts=options.readFormatOptions(this,options.formatOptions);var view=$.nub.view(ref,this,options.context,fopts)}}$(this).data("nub.context",options.context);$(this).data("nub.ref",ref);$(this).data("nub.view",view)});return this}})(jQuery);