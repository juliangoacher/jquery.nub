(function($){if(!$.nub){throw new Error("jquery.nub.js required")}$.nub.frames={};$.nub.type("/setup/*",$.nub.model.types.remote);function Frame(options){options=options||{};this.loadLayout=options.loadLayout||$.nub.noop;this.loadData=options.loadData||$.nub.noop;this.init=options.init||$.nub.noop;this.update=options.update||function(elem,keyRef,context){var key=$.nub.get(keyRef,context);this.loadLayout(elem,key);this.loadData(key);this.onupdate(elem,keyRef,context,key)};this.onupdate=options.onupdate||$.nub.noop}function makeContentVisible(elem,cid){var content=$(elem).data("content");if(content===undefined){throw new Error("makeContentVisible(): element must have a 'content' data item")}if(content["$visible"]){$(content["$visible"]).hide();delete content["$visible"]}if(cid&&content[cid]){content["$visible"]=content[cid];$(content["$visible"]).show();return true}return false}DynamicFrame.prototype=new Frame();function DynamicFrame(options){this.makeLayoutURI=options.makeLayoutURI||$.coop.identity;this.makeContentItem=options.makeContentItem||function(){return document.createElement("div")};this.makeSetupURI=options.makeSetupURI||function(key){return this.makeLayoutURI(key)+".setup.js"};this.init=function(elem){$(elem).data("content",{})};this.loadLayout=function(elem,key){if(key===undefined){makeContentVisible(elem,"__default__")}else{if(!makeContentVisible(elem,key)){var item=elem.appendChild(this.makeContentItem());var setupURI=this.makeSetupURI(key);var setupRef="/setup/"+encodeURIComponent(setupURI);var setup=$.nub.get(setupRef);setup.lazyLoad(setupURI,"text");var uri=this.makeLayoutURI(key);function applySetup(){setup.whenAvailable(function(setup){window.setTimeout(function(){if(setup.meta["ajax-status"]=="parsererror"){throw new Error("Error parsing setup file: "+setupURI)}eval("var setupFn="+setup.data);setup.data=setupFn;if($.isFunction(setup.data)){setup.data.apply(item)}else{throw new Error("Setup data must be a function: "+setupURI)}},0)})}$(item).load(uri,undefined,applySetup);var content=$(elem).data("content");content[key]=item;content["$visible"]=item}}}}$.nub.frames.Frame=Frame;$.nub.frames.DynamicFrame=DynamicFrame;HTMLFrame.prototype=new Frame({loadLayout:function(elem,key){$(elem).load(key)}});function HTMLFrame(){}$.nub.frames.HTMLFrame=HTMLFrame;$.nub.model.options.contentIDAttr="id";SwitchedHTMLFrame.prototype=new Frame({init:function(elem){var cid=this.cid;var content={};$(elem).data("content",content).data("cid",cid).children("["+cid+"]").each(function(){content[$(this).attr(cid)]=this;$(this).hide()})},loadLayout:function(elem,key){if(!makeContentVisible(elem,key)){makeContentVisible(elem,"$default")}}});function SwitchedHTMLFrame(options){this.cid=$.nub.model.options.contentIDAttr;if(options!==undefined&&options.cid!==undefined){this.cid=options.cid}}$.nub.frames.SwitchedHTMLFrame=SwitchedHTMLFrame;$.fn.nubFrame=function(options){if(options===undefined){throw new Error("No frame options supplied")}var frame=options.frame||new Frame(options);if(!$.isFunction(frame.update)){throw new Error('Frame object must have an "update" method')}var getKeyRef;if(options.keyRef!==undefined){getKeyRef=$.nub.constant(options.keyRef)}else{if($.isFunction(options.getKeyRef)){getKeyRef=options.keyRefFn}else{if($.isFunction(frame.getKeyRef)){getKeyRef=frame.getKeyRef}else{throw new Error("Unable to resolve key reference")}}}return $(this).each(function(){var elem=this;if($.isFunction(frame.init)){frame.init(elem)}var keyRef=getKeyRef(elem);$.nub.view(keyRef,function(){frame.update(elem,keyRef,options.context)},options.context)})}})(jQuery);